<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CrowdHelp - Ayuda a Choco</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
      --brand:#2563eb; --brand-600:#1d4ed8; --success:#16a34a; --radius:16px; --shadow:0 4px 12px rgba(2,8,23,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter, sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    .container{max-width:1180px;margin:0 auto;padding:0 20px}

    /* Navbar */
    .navbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800;font-size:1.3rem}
    .brand i{color:var(--brand);font-size:1.5rem}
    .nav-stats{display:flex;gap:.8rem;color:var(--muted);font-size:.9rem}
    .chip{display:flex;align-items:center;gap:.45rem;background:#f1f5f9;border:1px solid var(--border);padding:.35rem .7rem;border-radius:999px}

    /* Hero */
    .hero{padding:28px 0}
    .hero-card{display:grid;grid-template-columns:1.8fr 1fr;gap:20px;align-items:start}
    .panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
    .kicker{display:inline-flex;align-items:center;gap:.5rem;color:var(--brand);font-weight:700;background:#e0edff;border:1px solid #c7dbff;border-radius:999px;padding:.3rem .7rem}
    .title{font-size:2rem;line-height:1.15;font-weight:800;margin:12px 0 6px}
    .subtitle{color:var(--muted);margin-bottom:14px}
    .hero-actions{display:flex;gap:.6rem;flex-wrap:wrap}
    .btn{display:flex;align-items:center;justify-content:center;gap:.5rem;font-weight:700;border-radius:8px;padding:.7rem 1rem;border:1px solid transparent;cursor:pointer;transition:.15s ease;}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary:hover{background:var(--brand-600)}
    .btn-ghost{background:#fff;border-color:var(--border);color:var(--text)}

    /* Right panel */
    .amount{font-size:1.4rem;font-weight:800;color:var(--success)}
    .goal{color:var(--muted);margin-top:2px;font-size:.9rem}
    .bar{height:10px;border-radius:999px;background:#eef2f7;border:1px solid var(--border);overflow:hidden;margin:8px 0}
    .fill{height:100%;width:35%;background:linear-gradient(90deg,var(--brand),#60a5fa)}
    .percent{font-weight:700;color:#334155;font-size:.9rem}

    /* Main */
    main.container{display:grid;grid-template-columns:1.8fr 1fr;gap:20px;margin:20px auto;align-items:start}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .story h2{font-size:1.3rem;margin-bottom:10px}
    .story p{margin-bottom:10px;font-size:.95rem}
    .list{margin-left:1rem;font-size:.95rem}
    .list div{margin-bottom:5px}
    .quote{color:var(--muted);border-left:3px solid #cbd5e1;padding-left:12px;font-style:italic;font-size:.9rem}

    /* Comments */
    .comments{margin-top:16px}
    .comments-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .comments h3{font-size:1.05rem}
    .comment{display:grid;grid-template-columns:44px 1fr;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:10px}
    .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;background:#e2e8f0;color:#0f172a}
    .author{font-weight:700}
    .donation{color:var(--success);font-size:.92rem}
    .empty{color:var(--muted);font-style:italic}

    /* Sidebar */
    .sidebar{position:sticky;top:86px;display:grid;gap:14px}
    .share{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px}
    .btn-fb{background:#1877f2;color:#fff}
    .btn-x{background:#0f1419;color:#fff}
    .btn-wa{background:#25d366;color:#fff}
    .meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .pill{background:#f1f5f9;border:1px solid var(--border);color:#0f172a;border-radius:999px;padding:.3rem .6rem;font-weight:600;font-size:.8rem}

    /* Dialog */
    dialog{border:none;padding:0;border-radius:14px;box-shadow:0 20px 60px rgba(2,8,23,.18);width:min(560px,92vw)}
    .dialog-body{padding:18px}
    .field{display:grid;gap:6px;margin-bottom:10px}
    .field label{font-weight:600;font-size:.9rem}
    .input, textarea{border:1px solid var(--border);border-radius:10px;padding:.65rem .75rem;font:inherit}
    textarea{min-height:90px;resize:vertical}
    .dialog-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .btn-secondary{background:#fff;border:1px solid var(--border)}

    /* Footer */
    .visitor{position:fixed;left:20px;bottom:20px;padding:8px 12px;border-radius:999px;background:#0f172a;color:#fff;border:1px solid #1f2937;box-shadow:var(--shadow);z-index:60;font-weight:600;font-size:.85rem}

    @media(max-width:980px){.hero-card,main.container{grid-template-columns:1fr}.sidebar{position:static}}
  </style>
</head>
<body>
  <header class="navbar">
    <div class="container nav-inner">
      <div class="brand"><i class="fa-solid fa-hand-holding-heart"></i><span>CrowdHelp</span></div>
      <div class="nav-stats">
        <span class="chip"><i class="fa-solid fa-users"></i> <span id="totalUsers">23,847</span> activos</span>
        <span class="chip"><i class="fa-solid fa-dollar-sign"></i> $2.8M hoy</span>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container hero-card">
      <div class="panel">
        <span class="kicker">URGENTE · Ayuda médica</span>
        <h1 class="title">Ayuda a Choco con su vasectomía</h1>
        <p class="subtitle">Una decisión responsable que necesita tu apoyo.</p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="simulateDonation()"><i class="fa-solid fa-heart"></i> Donar ahora</button>
          <button class="btn btn-ghost" onclick="document.getElementById('historia').scrollIntoView({behavior:'smooth'})"><i class="fa-solid fa-circle-info"></i> Ver historia</button>
          <button class="btn btn-ghost" onclick="openCommentDialog()"><i class="fa-solid fa-message"></i> Dejar comentario</button>
        </div>
      </div>
      <div class="panel">
        <div class="amount">$<span id="currentAmount">8,750</span> MXN</div>
        <div class="goal">Recaudado de <strong>$25,000 MXN</strong> objetivo</div>
        <div class="bar"><div id="progressBar" class="fill" style="width:35%"></div></div>
        <div class="percent"><span id="progressPercent">35</span>% completado</div>
      </div>
    </div>
  </section>

  <main class="container">
    <article id="historia" class="card story">
      <h2><i class="fa-solid fa-stethoscope" style="color:var(--brand)"></i> La historia de Choco</h2>
      <p>Estimados amigos y familiares,</p>
      <p>Mi nombre es Choco, y después de mucha reflexión y consultas médicas, he tomado la decisión responsable de realizarme una vasectomía. Esta es una decisión personal importante que he meditado con mi pareja y mi médico.</p>
      <p><strong>¿Por qué necesito tu ayuda?</strong></p>
      <div class="list">
        <div>• Consulta preoperatoria especializada</div>
        <div>• Estudios médicos necesarios</div>
        <div>• Procedimiento quirúrgico</div>
        <div>• Depilación preoperatoria</div>
        <div>• Medicamentos y seguimiento post-operatorio</div>
        <div>• Consultas de control durante 3 meses</div>
      </div>
      <p>Esta decisión representa un acto de responsabilidad hacia mi futuro y el de mi familia. La vasectomía es un procedimiento seguro, efectivo y permanente que me permitirá tener control sobre mi planificación familiar.</p>
      <p><strong>Tu apoyo significa mucho.</strong> Cualquier cantidad, por pequeña que sea, me acerca más a mi objetivo. Si no puedes donar, te agradeceré que compartas esta campaña.</p>
      <p class="quote">“La responsabilidad es el precio de la libertad” – Choco, 2025</p>

      <!-- Comentarios existentes -->
      <section class="comments" aria-label="Comentarios y donaciones">
        <div class="comments-header">
          <h3><i class="fa-solid fa-comments" style="color:var(--brand)"></i> Comentarios y donaciones</h3>
          <button class="btn btn-ghost" onclick="openCommentDialog()"><i class="fa-solid fa-plus"></i> Agregar</button>
        </div>
        <div id="commentsList">
          <!-- Comentarios seed -->
          <div class="comment">
            <div class="avatar">M</div>
            <div>
              <div class="author">María González</div>
              <div class="donation">Donó $500</div>
              <div>¡Qué decisión tan valiente y responsable! Todo mi apoyo para ti, Choco.</div>
            </div>
          </div>
          <div class="comment">
            <div class="avatar">J</div>
            <div>
              <div class="author">Jorge Ramírez</div>
              <div class="donation">Donó $300</div>
              <div>Hermano, admiro tu decisión. ¡Cuenta conmigo siempre!</div>
            </div>
          </div>
          <div class="comment">
            <div class="avatar">R</div>
            <div>
              <div class="author">Rogelio López</div>
              <div class="donation">Donó $1,000</div>
              <div>¡Eres un ejemplo de responsabilidad! Te apoyamos.</div>
            </div>
          </div>
          <div class="comment">
            <div class="avatar">D</div>
            <div>
              <div class="author">Dr. Fernández</div>
              <div class="donation">Donó $800</div>
              <div>Como médico, aplaudo tu decisión informada. ¡Éxito en el procedimiento!</div>
            </div>
          </div>
        </div>
      </section>
    </article>

    <aside class="sidebar">
      <div class="card">
        <button class="btn btn-primary" style="width:100%" onclick="simulateDonation()"><i class="fa-solid fa-heart"></i> Donar ahora</button>
        <div class="share">
          <button class="btn btn-fb" onclick="shareOn('facebook')"><i class="fab fa-facebook-f"></i></button>
          <button class="btn btn-x" onclick="shareOn('twitter')"><i class="fa-brands fa-x-twitter"></i></button>
          <button class="btn btn-wa" onclick="shareOn('whatsapp')"><i class="fab fa-whatsapp"></i></button>
        </div>
        <div class="meta">
          <span class="pill"><i class="fa-solid fa-shield"></i> Donaciones seguras</span>
          <span class="pill"><i class="fa-regular fa-clock"></i> Última donación: 12 min</span>
        </div>
      </div>
    </aside>
  </main>

  <div class="visitor"><i class="fa-regular fa-eye"></i> Visitantes online: <span id="visitorCount">47</span></div>

  <!-- Cuadro de diálogo para nuevo comentario -->
  <dialog id="commentDialog">
    <form id="commentForm" method="dialog">
      <div class="dialog-body">
        <h3 style="font-family:Manrope,Inter,sans-serif;font-size:1.1rem;margin-bottom:8px">Nuevo comentario</h3>
        <div class="field">
          <label for="name">Nombre</label>
          <input class="input" id="name" name="name" placeholder="Tu nombre" required />
        </div>
        <div class="field">
          <label for="amount">Donación (opcional)</label>
          <input class="input" id="amount" name="amount" type="number" min="0" step="50" placeholder="Ej. 500" />
        </div>
        <div class="field">
          <label for="message">Comentario</label>
          <textarea id="message" name="message" maxlength="400" placeholder="Escribe un mensaje de apoyo" required></textarea>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-secondary" type="button" onclick="closeCommentDialog()">Cancelar</button>
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-paper-plane"></i> Publicar</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // --- Firebase Configuration ---
    // IMPORTANTE: Reemplaza estos valores con tu configuración de Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // --- Helpers ---
    const parseNum = (s) => parseInt(String(s).replace(/[^0-9]/g, '')) || 0;
    const fmt = (n) => n.toLocaleString('es-MX');

    // --- Donación simulada ---
    function simulateDonation(){
      const goal = 25000;
      const amounts = [100,200,250,300,500,750,1000,1500];
      const add = amounts[Math.floor(Math.random()*amounts.length)];
      const amountEl = document.getElementById('currentAmount');
      const barEl = document.getElementById('progressBar');
      const percentEl = document.getElementById('progressPercent');

      const current = parseNum(amountEl.textContent);
      const next = current + add;
      const pct = Math.min(100, Math.round((next/goal)*100));
      amountEl.textContent = fmt(next);
      barEl.style.width = pct + '%';
      percentEl.textContent = fmt(pct);

      toast(`¡Gracias por tu donación de ${fmt(add)} MXN!`);
    }

    // --- Compartir ---
    function shareOn(platform){
      const data = {title:'CrowdHelp - Ayuda a Choco', text:'Apoya la campaña de Choco', url: location.href};
      if (navigator.share) navigator.share(data).catch(()=>{}); else alert('Compartido en ' + (platform==='twitter'? 'X' : platform));
    }

    // --- Visitantes online ---
    function updateVisitorCount(){
      const el = document.getElementById('visitorCount');
      if(!el) return; const cur = parseNum(el.textContent);
      const change = Math.random()>0.7 ? (Math.random()>0.5?1:-1) : 0;
      el.textContent = Math.max(20, cur + change);
    }
    setInterval(updateVisitorCount, 5000);

    // --- Comentarios con Firebase ---
    const listEl = document.getElementById('commentsList');
    
    // Cargar comentarios desde Firestore
    async function loadComments(){
      try {
        const snapshot = await db.collection('comments')
          .orderBy('timestamp', 'desc')
          .limit(50)
          .get();
        
        snapshot.forEach(doc => {
          const comment = doc.data();
          addCommentToDOM(comment, false); // false para no duplicar los seed comments
        });
      } catch (error) {
        console.error('Error cargando comentarios:', error);
        // Fallback a localStorage si Firebase falla
        loadCommentsFromLocalStorage();
      }
    }
    
    // Guardar comentario en Firestore
    async function saveComment(c){
      try {
        // Agregar timestamp al comentario
        const commentWithTime = {
          ...c,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Guardar en Firestore
        await db.collection('comments').add(commentWithTime);
        
        // También guardar en localStorage como backup
        saveCommentToLocalStorage(c);
        
        return true;
      } catch (error) {
        console.error('Error guardando comentario:', error);
        // Si falla, guardar solo en localStorage
        saveCommentToLocalStorage(c);
        return false;
      }
    }
    
    // Funciones de respaldo con localStorage
    const COMMENTS_KEY = 'crowdhelp_comments_v1';
    
    function loadCommentsFromLocalStorage(){
      const raw = localStorage.getItem(COMMENTS_KEY);
      if(!raw) return;
      const arr = JSON.parse(raw);
      arr.forEach(c => addCommentToDOM(c, false));
    }
    
    function saveCommentToLocalStorage(c){
      const raw = localStorage.getItem(COMMENTS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      arr.unshift(c);
      localStorage.setItem(COMMENTS_KEY, JSON.stringify(arr));
    }
    function avatarFrom(name){ return (name||'?').trim().charAt(0).toUpperCase() || '?'; }
    function addCommentToDOM({name, amount, message}, prepend = true){
      const wrap = document.createElement('div');
      wrap.className = 'comment';
      wrap.innerHTML = `
        <div class="avatar">${avatarFrom(name)}</div>
        <div>
          <div class="author">${escapeHtml(name)}</div>
          ${amount>0 ? `<div class="donation">Donó $${fmt(amount)}</div>` : ''}
          <div>${escapeHtml(message)}</div>
        </div>`;
      if(prepend) {
        listEl.prepend(wrap);
      } else {
        listEl.appendChild(wrap);
      }
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    // Dialog helpers
    const dialog = document.getElementById('commentDialog');
    function openCommentDialog(){ dialog.showModal(); }
    function closeCommentDialog(){ dialog.close(); }
    window.openCommentDialog = openCommentDialog;
    window.closeCommentDialog = closeCommentDialog;

    document.getElementById('commentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const amount = parseInt(document.getElementById('amount').value||0,10);
      const message = document.getElementById('message').value.trim();
      if(!name || !message){ return; }
      const comment = {name, amount: isNaN(amount)?0:amount, message};
      
      // Mostrar el comentario inmediatamente
      addCommentToDOM(comment);
      
      // Guardar en Firebase de forma asíncrona
      const saved = await saveComment(comment);
      if(saved) {
        toast('¡Comentario publicado con éxito!');
      } else {
        toast('Comentario guardado localmente');
      }
      
      dialog.close();
      e.target.reset();
    });

    // Cargar comentarios cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      // Esperar un momento para que Firebase se inicialice
      setTimeout(() => {
        loadComments();
      }, 1000);
    });
    
    // Escuchar cambios en tiempo real (opcional pero muy útil)
    db.collection('comments')
      .orderBy('timestamp', 'desc')
      .limit(1)
      .onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added' && change.doc.data().timestamp) {
            // Solo agregar si es un comentario nuevo (no los que ya cargamos)
            const comment = change.doc.data();
            // Verificar que no sea un comentario que acabamos de agregar localmente
            const existingComments = listEl.querySelectorAll('.comment');
            const exists = Array.from(existingComments).some(el => {
              const authorEl = el.querySelector('.author');
              return authorEl && authorEl.textContent === comment.name;
            });
            if (!exists) {
              addCommentToDOM(comment);
            }
          }
        });
      });

    // --- Toast ---
    function toast(text){
      const t = document.createElement('div');
      t.textContent = text;
      t.style.cssText = 'position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(2,8,23,.2);z-index:1000;opacity:0;transform:translateY(6px);transition:.2s';
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity = 1; t.style.transform = 'translateY(0)'; });
      setTimeout(()=>{ t.style.opacity = 0; t.style.transform = 'translateY(6px)'; setTimeout(()=>t.remove(),200); }, 2000);
    }
  </script>
</body>
</html>
